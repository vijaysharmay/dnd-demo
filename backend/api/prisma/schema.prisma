// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["omitApi"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  DESIGNER
  DEVELOPER
  OWNER
}

model User {
  id               String              @id @map("id")
  fullName         String              @map("full_name")
  email            String              @unique @map("email")
  passwd           String
  salt             String
  ownerOfWorkspace Workspace[]         @relation(name: "ownerOfWorkspace")
  ownerOfProject   Project[]           @relation(name: "ownerOfProject")
  ownerOfPage      Page[]              @relation(name: "ownerOfPage")
  workspaces       UserWorkspaceRole[] @relation(name: "userOfWorkspace")

  @@map("users")
}

model Workspace {
  id       String              @id @map("id")
  name     String              @unique @map("workspace_name")
  owner    User                @relation(fields: [ownerId], references: [id], name: "ownerOfWorkspace")
  ownerId  String              @unique
  route    String              @unique @map("workspace_route")
  members  UserWorkspaceRole[] @relation(name: "workspaceForUser")
  projects Project[]           @relation(name: "partOfWorkspace")
  pages    Page[]              @relation(name: "partOfWorkspacePage")
  blocks   Block[]             @relation(name: "partOfWorkspacePageBlock")

  @@map("workspaces")
}

model UserWorkspaceRole {
  user        User      @relation(fields: [userId], references: [id], name: "userOfWorkspace", onDelete: Cascade, onUpdate: Cascade, map: "user_of_workspace_fkey")
  userId      String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], name: "workspaceForUser", onDelete: Cascade, onUpdate: Cascade, map: "workspace_for_user_fkey")
  workspaceId String
  role        UserRole

  @@id([userId, workspaceId])
  @@map("role_for_user_in_workspace")
}

model Project {
  id          String    @id @map("id")
  name        String    @map("name")
  owner       User      @relation(fields: [ownerId], references: [id], name: "ownerOfProject")
  ownerId     String    @unique
  workspace   Workspace @relation(fields: [workspaceId], references: [id], name: "partOfWorkspace")
  workspaceId String    @unique
  route       String    @unique @map("route")
  pages       Page[]    @relation(name: "partOfProject")
  blocks      Block[]   @relation(name: "partOfProjectPage")

  @@map("projects")
}

model Page {
  id          String    @id @map("id")
  name        String    @map("name")
  owner       User      @relation(fields: [ownerId], references: [id], name: "ownerOfPage")
  ownerId     String    @unique
  project     Project   @relation(fields: [projectId], references: [id], name: "partOfProject")
  projectId   String    @unique
  workspace   Workspace @relation(fields: [workspaceId], references: [id], name: "partOfWorkspacePage")
  workspaceId String    @unique
  route       String    @unique @map("route")
  blocks      Block[]   @relation(name: "partOfPage")

  @@unique([workspaceId, projectId])
  @@map("pages")
}

model Block {
  id          String    @id @map("id")
  blockId     String    @unique @map("block_id")
  blockType   String    @map("block_type") //should be enum
  props       Json      @map("props")
  order       Int?      @default(0) @map("order") // only relevant for child blocks
  children    Block[]   @relation("nestedBlocks")
  parent      Block?    @relation("nestedBlocks", fields: [parentId], references: [id])
  parentId    String?
  page        Page      @relation(fields: [pageId], references: [id], name: "partOfPage")
  pageId      String
  project     Project   @relation(fields: [projectId], references: [id], name: "partOfProjectPage")
  projectId   String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], name: "partOfWorkspacePageBlock")
  workspaceId String
  flow        Flow[]    @relation(name: "hasFlow")

  @@map("blocks")
}

model Flow {
  id           String   @id @map("id")
  name         String   @map("name")
  triggerEvent String   @map("trigger_event") // should be enum
  ofBlock      Block    @relation(name: "hasFlow", fields: [blockId], references: [id])
  blockId      String
  actions      Action[]
  // actions      ActionsInFlows[] @relation(name: "partOfFlow")

  @@map("flows")
}

model Action {
  id           String @id @map("id")
  actionId     String @unique @map("action_id")
  actionType   String @map("action_type") // should be enum
  defaultProps Json   @map("default_props")
  props        Json?  @map("props")
  route        String @unique @map("route")
  flows        Flow[]
  // flows        ActionsInFlows[] @relation(name: "partOfAction")

  @@map("actions")
}

// model ActionsInFlows {
//   flow     Flow   @relation(fields: [flowId], references: [id], name: "partOfFlow", map: "flow_workspace_fk")
//   flowId   String
//   action   Action @relation(fields: [actionId], references: [id], name: "partOfAction")
//   actionId String

//   @@id([flowId, actionId])
//   @@map("actions_in_flows")
// }
